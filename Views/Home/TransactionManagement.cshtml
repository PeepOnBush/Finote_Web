@model Finote_Web.ViewModels.TransactionManagementViewModel
@{
    ViewData["Title"] = "Transaction Management";
}

<main>
    <div class="page-header">
        <h1>Transaction Management</h1>
        <p>View, edit, and analyze all user transactions.</p>
    </div>

    <!-- Stats Cards Grid remains the same -->
    <div class="stats-grid">
        <!-- ... -->
    </div>

    <div class="content-card">
        <!-- Filter Form -->
        <form asp-action="TransactionManagement" method="get" class="toolbar" style="flex-wrap: wrap; gap: 10px;">

            <!-- Search -->
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="search" name="searchString" value="@ViewBag.CurrentFilter" placeholder="Search note, category, user...">
            </div>

            <!-- Filter By Type -->
            <select name="typeFilter" class="form-control" style="width: auto; display: inline-block;">
                <option value="All" selected="@(ViewBag.TypeFilter == "All")">All Types</option>
                <option value="Income" selected="@(ViewBag.TypeFilter == "Income")">Income Only</option>
                <option value="Expense" selected="@(ViewBag.TypeFilter == "Expense")">Expense Only</option>
            </select>

            <!-- Date Range -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="date" name="startDate" value="@ViewBag.StartDate" class="form-control" placeholder="Start Date">
                <span>to</span>
                <input type="date" name="endDate" value="@ViewBag.EndDate" class="form-control" placeholder="End Date">
            </div>

            <!-- Filter Button -->
            <button type="submit" class="btn-secondary" style="padding: 10px 15px;">Filter</button>

            <!-- Clear Filters Link -->
            <a asp-action="TransactionManagement" class="btn-secondary" style="text-decoration:none; display:flex; align-items:center;">Reset</a>

        </form>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>AMOUNT</th>
                        <th>CATEGORY</th>
                        <th>NOTE</th>
                        <th>USER</th>
                        <th>WALLET</th>
                        <th>DATE</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in Model.Transactions)
                    {
                        bool isExpense = new[] { 2, 3, 5 }.Contains(tx.TransactionTypeId);
                        string typeString = isExpense ? "Expense" : "Income";

                        <tr id="row-@tx.Id"
                            data-state="visible"
                            data-amount="@tx.Amount.ToString("N2")"
                            data-type="@typeString"
                            data-category="@tx.CategoryName"
                            data-note="@tx.Note"
                            data-user="@tx.UserName"
                            data-wallet="@tx.WalletName"
                            data-date="@tx.TransactionDate.ToString("yyyy-MM-dd")">

                            <td>@tx.Id</td>

                            <!-- ===== ADD SPECIFIC CLASSES TO EACH TD ===== -->
                            <td class="cell-amount">
                                <span class="toggle-data">
                                    <span class="amount @(isExpense ? "expense" : "income")">
                                        @(isExpense ? "- " : "+ ")@tx.Amount.ToString("N2")
                                    </span>
                                </span>
                            </td>
                            <td class="cell-category"><span class="toggle-data">@tx.CategoryName</span></td>
                            <td class="cell-note"><span class="toggle-data">@tx.Note</span></td>
                            <td class="cell-user"><span class="toggle-data">@tx.UserName</span></td>
                            <td class="cell-wallet"><span class="toggle-data">@tx.WalletName</span></td>
                            <td class="cell-date"><span class="toggle-data">@tx.TransactionDate.ToString("yyyy-MM-dd")</span></td>
                            <!-- ============================================= -->

                            <td class="actions-cell">
                                <button type="button" class="action-btn toggle-visibility-btn" data-id="@tx.Id" title="Toggle Visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButtons = document.querySelectorAll('.toggle-visibility-btn');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    const row = document.getElementById(`row-${transactionId}`);
                    const icon = this.querySelector('i');
                    const dataSpans = row.querySelectorAll('.toggle-data');

                    if (!row || !icon || dataSpans.length === 0) {
                        return; // Exit if elements are missing
                    }

                    const currentState = row.getAttribute('data-state');

                    if (currentState === 'visible') {
                        // --- HIDE THE DATA ---
                        dataSpans.forEach(span => {
                            span.textContent = '****';
                        });

                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        row.setAttribute('data-state', 'hidden');
                    } else {
                        // --- SHOW THE DATA (THE CORRECTED LOGIC) ---
                        const amount = row.getAttribute('data-amount');
                        const type = row.getAttribute('data-type');
                        const category = row.getAttribute('data-category');
                        const note = row.getAttribute('data-note');
                        const user = row.getAttribute('data-user');
                        const wallet = row.getAttribute('data-wallet');
                        const date = row.getAttribute('data-date');

                        const sign = type === 'Income' ? '+ ' : '- ';
                        const amountClass = type === 'Income' ? 'income' : 'expense';
                        const amountHtml = `<span class="amount ${amountClass}">${sign}${amount}</span>`;

                        // Use the specific classes to restore data to the correct cells
                        row.querySelector('.cell-amount .toggle-data').innerHTML = amountHtml;
                        row.querySelector('.cell-category .toggle-data').textContent = category;
                        row.querySelector('.cell-note .toggle-data').textContent = note;
                        row.querySelector('.cell-user .toggle-data').textContent = user;
                        row.querySelector('.cell-wallet .toggle-data').textContent = wallet;
                        row.querySelector('.cell-date .toggle-data').textContent = date;

                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        row.setAttribute('data-state', 'visible');
                    }
                });
            });
        });
    </script>
}