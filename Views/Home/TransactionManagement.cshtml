@model Finote_Web.ViewModels.TransactionManagementViewModel
@{
    ViewData["Title"] = "Transaction Management";
}

<main>
    <div class="page-header">
        <h1>Transaction Management</h1>
        <p>View, edit, and analyze all user transactions.</p>
    </div>

    <!-- Stats Cards Grid remains the same -->
    <div class="stats-grid">
        <!-- ... -->
    </div>

    <div class="content-card">
        <div class="toolbar">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="search" placeholder="Search by note, category, or user...">
            </div>
            <!-- The "Add New" button is not part of this feature, so it remains -->
            <a href="#" class="btn-primary"><i class="fas fa-plus"></i> Add New Transaction</a>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>AMOUNT</th>
                        <th>CATEGORY</th>
                        <th>NOTE</th>
                        <th>USER</th>
                        <th>WALLET</th>
                        <th>DATE</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in Model.Transactions)
                    {
                        <!-- ===== KEY CHANGES ARE IN THIS ROW ===== -->
                        <tr id="row-@tx.Id"
                            data-state="visible"
                            data-amount="@tx.Amount.ToString("N2")"
                            data-type="@tx.TransactionType"
                            data-category="@tx.CategoryName"
                            data-note="@tx.Note"
                            data-user="@tx.UserName"
                            data-wallet="@tx.WalletName"
                            data-date="@tx.TransactionDate.ToString("yyyy-MM-dd")">

                            <td class="cell-amount">
                                <span class="toggle-data">
                                    <span class="amount @(tx.TransactionType == "Income" ? "income" : "expense")">
                                        @(tx.TransactionType == "Income" ? "+ " : "- ")@tx.Amount.ToString("N2")
                                    </span>
                                </span>
                            </td>
                            <td><span class="toggle-data">@tx.CategoryName</span></td>
                            <td><span class="toggle-data">@tx.Note</span></td>
                            <td><span class="toggle-data">@tx.UserName</span></td>
                            <td><span class="toggle-data">@tx.WalletName</span></td>
                            <td><span class="toggle-data">@tx.TransactionDate.ToString("yyyy-MM-dd")</span></td>
                            <td class="actions-cell">
                                <button type="button" class="action-btn toggle-visibility-btn" data-id="@tx.Id" title="Toggle Visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>   
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</main>

@section Scripts {
    <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const toggleButtons = document.querySelectorAll('.toggle-visibility-btn');

                    toggleButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const transactionId = this.getAttribute('data-id');
                            const row = document.getElementById(`row-${transactionId}`);
                            const icon = this.querySelector('i');
                            const dataSpans = row.querySelectorAll('.toggle-data');

                            if (!row || !icon || dataSpans.length === 0) {
                                console.error('Could not find required elements for transaction ID:', transactionId);
                                return;
                            }

                            const currentState = row.getAttribute('data-state');

                            if (currentState === 'visible') {
                                // --- HIDE THE DATA ---
                                // Simply replace the content of each target span with asterisks
                                dataSpans.forEach(span => {
                                    span.textContent = '****';
                                });

                                icon.classList.remove('fa-eye');
                                icon.classList.add('fa-eye-slash');
                                row.setAttribute('data-state', 'hidden');
                            } else {
                                // --- SHOW THE DATA ---
                                // Get all original data from the row's data-* attributes
                                const amount = row.getAttribute('data-amount');
                                const type = row.getAttribute('data-type');
                                const category = row.getAttribute('data-category');
                                const note = row.getAttribute('data-note');
                                const user = row.getAttribute('data-user');
                                const wallet = row.getAttribute('data-wallet');
                                const date = row.getAttribute('data-date');

                                // Reconstruct the formatted amount HTML
                                const sign = type === 'Income' ? '+ ' : '- ';
                                const amountClass = type === 'Income' ? 'income' : 'expense';
                                const amountHtml = `<span class="amount ${amountClass}">${sign}${amount}</span>`;

                                // Restore the original content by finding the correct span
                                // This approach is more robust
                                row.querySelector('.cell-amount .toggle-data').innerHTML = amountHtml;
                                row.querySelector('td:nth-child(2) .toggle-data').textContent = category;
                                row.querySelector('td:nth-child(3) .toggle-data').textContent = note;
                                row.querySelector('td:nth-child(4) .toggle-data').textContent = user;
                                row.querySelector('td:nth-child(5) .toggle-data').textContent = wallet;
                                row.querySelector('td:nth-child(6) .toggle-data').textContent = date;

                                icon.classList.remove('fa-eye-slash');
                                icon.classList.add('fa-eye');
        -                        row.setAttribute('data-state', 'visible');
                            }
                        });
                    });
                });
    </script>
}