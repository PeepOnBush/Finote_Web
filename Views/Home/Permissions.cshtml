@using Finote_Web.ViewModels
@model PermissionsViewModel
@{
    ViewData["Title"] = "Permissions & Security";
    var activeTab = ViewData["ActiveTab"] as string ?? "roles";

}
<main>
    <div class="page-header">
        <h1>Trang Phân Quyền và Bảo Mật</h1>
        <p>Authorization and Security Page</p>
    </div>

    <div class="content-card">
        <nav class="tab-nav">
            <button class="tab-link @(activeTab == "roles" ? "active" : "")" data-tab="roles">Danh sách Role</button>
            <button class="tab-link @(activeTab == "permissions" ? "active" : "")" data-tab="permissions">Chỉnh sửa quyền</button>
            <button class="tab-link @(activeTab == "assign" ? "active" : "")" data-tab="assign">Gán quyền cho user</button>
            <button class="tab-link @(activeTab == "logs" ? "active" : "")" data-tab="logs">Nhật ký hoạt động</button>
        </nav>

        <!-- Tab 1: Role List -->
        <div class="tab-content @(activeTab == "roles" ? "active" : "")" id="roles">
            <h4>Role List</h4>
            <p>Manage the roles available in the system.</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <!-- ===== REMOVE THE ACTIONS HEADER ===== -->
                            <th>ROLE NAME</th>
                            <th>USERS (Total)</th>
                            <!-- =================================== -->
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var role in Model.Roles)
                        {
                            <tr>
                                <td><span class="role-badge role-@(role.Name.ToLower())">@role.Name</span></td>
                                <td>@role.UserCount.ToString("N0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Edit Permissions (static for now) -->
        <div class="tab-content @(activeTab == "permissions" ? "active" : "")" id="permissions">
            <h4>Chỉnh sửa quyền (Edit Permissions)</h4>
            <p>Define which roles have access to specific pages.</p>
            <div class="table-wrapper">
                <form asp-action="UpdateRolePermissions" asp-controller="Home" method="post">
                    <table>
                        <thead>
                            <tr>
                                <th>PAGE / FEATURE</th>
                                <!-- 1. Dynamically create a header for each role -->
                                @for (int i = 0; i < Model.RolePermissions.Count; i++)
                                {
                                    <th>@Model.RolePermissions[i].RoleName.ToUpper()</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 2. Loop through the permissions of the FIRST role to create the rows -->
                            <!-- This assumes all roles are being checked against the same set of permissions -->
                            @for (int i = 0; i < Model.RolePermissions.FirstOrDefault()?.RoleClaims.Count; i++)
                            {
                                <tr>
                                    <!-- 3. Display the permission name -->
                                    <td>
                                        @{
                                            // Prettify the claim name for display
                                            var claimParts = Model.RolePermissions[0].RoleClaims[i].ClaimType.Split('.');
                                            var feature = claimParts.Length > 1 ? claimParts[1] : "";
                                            var action = claimParts.Length > 2 ? claimParts[2] : "";
                                        }
                                        <strong>@feature</strong>
                                        <span style="color: #777; margin-left: 5px;">(@action)</span>
                                    </td>

                                    <!-- 4. For each role, create the corresponding checkbox -->
                                    @for (int j = 0; j < Model.RolePermissions.Count; j++)
                                    {
                                        <td>
                                            <!-- Hidden fields are crucial for the model binder to rebuild the list on POST -->
                                            <input type="hidden" name="model[@j].RoleName" value="@Model.RolePermissions[j].RoleName" />
                                            <input type="hidden" name="model[@j].RoleClaims[@i].ClaimType" value="@Model.RolePermissions[j].RoleClaims[i].ClaimType" />

                                            <!-- The actual checkbox -->
                                            <input type="checkbox" name="model[@j].RoleClaims[@i].IsSelected" value="true"
                                                   checked="@Model.RolePermissions[j].RoleClaims[i].IsSelected"
                                                   disabled="@(Model.RolePermissions[j].RoleName == "Admin")" />
                                            <!-- We also need a hidden field for the 'false' value of the checkbox -->
                                            <input type="hidden" name="model[@j].RoleClaims[@i].IsSelected" value="false" />
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="modal-footer" style="background:none; padding-right:0;">
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- Tab 3: Assign Role (static for now) -->
        <div class="tab-content @(activeTab == "assign" ? "active" : "")" id="assign">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <div>
                    <h4>Gán quyền cho user (Assign Role to User)</h4>
                    <p style="margin-bottom:0;">Change a specific user's role.</p>
                </div>

                <!-- Search Form -->
                <form asp-action="Permissions" method="get">
                    <!-- Hidden input to ensure we stay on the Assign tab after search -->
                    <!-- Note: You might need JS to auto-switch tabs, but for now this searches. -->
                    <input type="hidden" name="activeTab" value="assign" />
                    <div class="search-wrapper" style="width: 300px;">
                        <i class="fas fa-search"></i>
                        <input type="search" name="searchString" value="@ViewData["CurrentFilter"]" placeholder="Search user..." style="width:100%;" onchange="this.form.submit()">
                    </div>
                </form>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>USER ID</th>
                            <th>USER</th>
                            <th>CURRENT ROLE</th>
                            <th>NEW ROLE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.UsersWithRoles)
                        {
                            <tr>
                                <td>
                                    <span style="font-size: 0.8rem; color: #777;">@user.UserId.Substring(0, 8)...</span>
                                </td>
                                <td>@user.UserName</td>
                                <td><span class="role-badge role-@(user.CurrentRole.ToLower())">@user.CurrentRole</span></td>
                                <td>
                                    <!-- Each row is its own form -->
                                    <form asp-action="UpdateUserRole" asp-controller="Home" method="post" class="assign-role-form">
                                        <input type="hidden" name="userId" value="@user.UserId" />
                                        <select name="newRole" class="form-control" onchange="this.form.submit()">
                                            @foreach (var roleOption in Model.AvailableRoles)
                                            {
                                                <option value="@roleOption.Value" selected="@(roleOption.Value == user.CurrentRole)">
                                                    @roleOption.Text
                                                </option>
                                            }
                                        </select>
                                        <!-- The form submits automatically when a new role is chosen -->
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 4: Activity Log -->
        <div class="tab-content @(activeTab == "logs" ? "active" : "")" id="logs">
            <h4>Nhật ký hoạt động (Activity Log)</h4>
            <form asp-action="ClearActivityLog" asp-controller="Home" method="post"
                  onsubmit="return confirm('Are you sure you want to permanently delete ALL activity logs?');">
                <button type="submit" class="btn-danger"><i class="fas fa-eraser"></i> Clear Activity Log</button>
            </form>
            <p>A log of important actions taken by users.</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Log ID</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.ActivityLogs)
                        {
                            <tr>
                                <td>@log.Id</td>
                                <td>@log.UserName</td>
                                <td>@log.Action</td>
                                <td>@log.Timestamp.ToString("g")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>